---
title: "Selection Bias & Missing Data Challenge - Part 2"
subtitle: "Creating a Statistics Meme: Visualizing Selection Bias"
format:
  html: default
execute:
  echo: false
  eval: true
---

```{r setup, include=FALSE}
# Setup chunk: Suppress warnings and messages for cleaner output
knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE
)
```


```{r}
#| label: load-images-r
#| echo: false
#| eval: true

library(imager)
library(magick)

# Load original image
original_img <- load.image('thumbsup.png')
if(dim(original_img)[3] == 3) {
  original_img <- grayscale(original_img)
}
# Convert to matrix [h, w] and normalize
# imager stores as [x, y] so we transpose to get [h, w]
arr <- as.array(original_img)
original_array <- t(arr[,,1,1]) / max(arr)

# Get dimensions
h <- nrow(original_array)
w <- ncol(original_array)

# Load stippled image (from Part 1)
# Try to load from saved file first
if(file.exists('stippleImage.rds')) {
  stipple_array <- readRDS('stippleImage.rds')
} else if(file.exists('../stippleChallenge/stippleImage.rds')) {
  stipple_array <- readRDS('../stippleChallenge/stippleImage.rds')
} else {
  # If no saved file, create placeholder
  stipple_array <- matrix(1.0, nrow = h, ncol = w)
}

# Check and fix dimensions if needed
if(!identical(dim(stipple_array), dim(original_array))) {
  if(nrow(stipple_array) != h || ncol(stipple_array) != w) {
    stipple_array <- matrix(1.0, nrow = h, ncol = w)
  }
}
```

```{r}
#| label: create-s-letter-r
#| echo: false
#| eval: true

# Create a white background image matching original dimensions
s_img <- image_blank(width = w, height = h, color = "white")

# Calculate font size (80-90% of image height)
font_size <- as.integer(h * 0.85)

# Create the "S" text with bold font
s_text <- image_annotate(
  s_img,
  text = "S",
  size = font_size,
  gravity = "center",
  font = "Arial-Bold",
  color = "black",
  weight = 700
)

# Save temporarily and load with imager for reliable conversion
temp_file <- tempfile(fileext = ".png")
image_write(s_text, temp_file)

# Load with imager
s_cimg_temp <- load.image(temp_file)
if(dim(s_cimg_temp)[3] == 3) {
  s_cimg_temp <- grayscale(s_cimg_temp)
}

# Convert to matrix [h, w] format
s_arr <- as.array(s_cimg_temp)
s_matrix <- t(s_arr[,,1,1]) / max(s_arr)

# Clean up temp file
unlink(temp_file)
```

```{r}
#| label: create-masked-estimate-r
#| echo: false
#| eval: true

# Create binary mask: pixels < threshold are part of the "S" (black = missing data)
threshold <- 0.5
s_mask <- s_matrix < threshold

# Apply mask to stippled image
# Where "S" is black (s_mask == TRUE), set pixels to white (1.0) - removing stipples
# Where "S" is white (s_mask == FALSE), keep original stipple values
masked_estimate <- ifelse(s_mask, 1.0, stipple_array)
```

```{r}
#| label: final-meme-generation
#| echo: false
#| eval: true
#| fig-width: 16
#| fig-height: 4
#| dpi: 300
#| fig-cap: "Four-panel statistics meme demonstrating selection bias: Reality (original image), Your Model (stippled version), Selection Bias (letter S), and Estimate (masked stippled image showing biased result)"

# Convert matrices to imager format
# All matrices are in [h, w] format, need to transpose to [w, h] for imager
# as.cimg needs: t(matrix), x = width (ncol), y = height (nrow), cc = 1 (grayscale)
original_cimg <- as.cimg(t(original_array), x = w, y = h, cc = 1)
stipple_cimg <- as.cimg(t(stipple_array), x = w, y = h, cc = 1)
s_cimg <- as.cimg(t(s_matrix), x = w, y = h, cc = 1)
masked_cimg <- as.cimg(t(masked_estimate), x = w, y = h, cc = 1)

# Create 1Ã—4 layout (horizontal)
par(mfrow = c(1, 4), mar = c(2, 2, 3, 2), bg = "pink")

# Panel 1: Reality (original image)
plot(original_cimg, axes = FALSE, main = "Reality", cex.main = 1.5)

# Panel 2: Your Model (stippled image)
plot(stipple_cimg, axes = FALSE, main = "Your Model", cex.main = 1.5)

# Panel 3: Selection Bias (S letter)
plot(s_cimg, axes = FALSE, main = "Selection Bias", cex.main = 1.5)

# Panel 4: Estimate (masked stippled image)
plot(masked_cimg, axes = FALSE, main = "Estimate", cex.main = 1.5)
```

## Understanding Selection Bias Through This Meme

This visualization demonstrates **selection bias**, which occurs when your sample doesn't match your population of interest. It causes your estimates to be systematically different to the true population, just like the masked Estimate panel shows. The "S" in this meme serves as a visual representation of this systematic error, distorting the results in a funny way. 